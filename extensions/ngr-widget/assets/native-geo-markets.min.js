var __defProp=Object.defineProperty,__defNormalProp=(t,e,o)=>e in t?__defProp(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o,__publicField=(t,e,o)=>__defNormalProp(t,"symbol"!=typeof e?e+"":e,o);!function(){"use strict";class t extends HTMLElement{constructor(){super(),__publicField(this,"HOST","https://ngr-app2.herokuapp.com"),__publicField(this,"MAIN_CSS","native-geo-markets.min.css"),__publicField(this,"SHOW_RULES",{load:"everyload",cookie:"cookie",session:"session"}),__publicField(this,"VARS",{KEY:"ngr-markets-session",CLOSED_KEY:"ngr-markets-closed"}),this.template=this.querySelector("#NGR-Markets-Template"),this.stylesheet=document.querySelector(`[href*='${this.MAIN_CSS}']`),this.widgetIcon=this.dataset.widgetIcon,this.widgetStickyIcon=this.dataset.widgetStickyIcon,this.modal=null,this.customOpenerIconSrc=this.dataset.customOpenerIconSrc,this.testMode=!1,this.userLocale=this.dataset.lng||window.Shopify.locale,this.shopifyTemplate=this.dataset.shopifyTemplate,this.shopifytemplateDir=this.dataset.shopifyTemplateDir,this.flagSrc=this.dataset.flagSrc,this.marketCountries=null,this.userGeoData}async connectedCallback(){var t,e;if(this.checkTestMode(),this.clearLocalData(),!this.stylesheet)return void console.error("[NGR APP]: Stylesheet not found. Contact app support.");const o=await this.getData();if(!o||!o&&!o.status||!o.data)return void console.error("[NGR APP]: Store data not found. Contact app support.");const n=await this.getGeo();if(!n||!(null==n?void 0:n.country))return void console.error("[NGR APP]: GEO Location not detected. Contact app support.");this.userGeoData=n;const{markets:i,configs:l}=o.data;if(i){if(null==l?void 0:l.widget){if(this.topBarMoveTop(null==(t=null==l?void 0:l.basic_configs)?void 0:t.type))return;const o=this.widget(i,l);if(!o)return void console.error("[NGR APP]: Widget not found. Contact app support.");const n=this.genCustomStyles(l),s=this.attachShadow({mode:"closed"});s.appendChild(this.stylesheet),n&&s.appendChild(n),s.appendChild(o),this.customOpenerIcon(),this.widgetEvents(s,null==(e=null==l?void 0:l.basic_configs)?void 0:e.showFrequency),await this.widgetLogic(s,null==l?void 0:l.basic_configs,i),this.displayWidget()}}else console.warn("[NGR APP]: Shopify Markets not configured.")}checkTestMode(){(window.location.search.includes("ngr-markets-test")||"#ngr-markets-test"===window.location.hash||"true"===this.dataset.testMode&&window.Shopify.designMode)&&(this.testMode=!0)}clearLocalData(){"#ngr-clear-user-data"===window.location.hash&&(this.deleteCookie(this.VARS.KEY),this.deleteCookie(this.VARS.CLOSED_KEY),sessionStorage.removeItem(this.VARS.KEY),sessionStorage.removeItem(this.VARS.CLOSED_KEY))}async getData(){var t;const e=null==(t=null==window?void 0:window.Shopify)?void 0:t.shop,o=`${this.HOST}/api/shop-markets?shop=${e}`;try{return await fetch(o).then(t=>t.json())}catch(n){console.log("Error",n)}}async getGeo(){var t,e,o,n,i;const l=this.getCookie(this.VARS.KEY);if(l&&!this.testMode)return JSON.parse(l);const s=await this.getCountriesJSON(),r=await fetch("/browsing_context_suggestions.json").then(t=>t.json());if(!s||!r)return console.error("[NGR APP]: User GEO location or countries list not detected. Contact app support please.");const a=null==(t=null==r?void 0:r.detected_values)?void 0:t.country.handle,d={country_name:(null==(o=null==(e=null==r?void 0:r.detected_values)?void 0:e.country)?void 0:o.name)||(null==(n=null==r?void 0:r.detected_values)?void 0:n.country_name),country:a,continent:null==(i=s[a])?void 0:i.continent};return this.setCookie(this.VARS.KEY,JSON.stringify(d),7),window[this.VARS.KEY]=d,d}topBarMoveTop(t){return"topbar"===t&&!this.hasAttribute("data-moved")&&(this.setAttribute("data-moved",""),document.body.insertBefore(this,document.body.firstChild),this.displayWidget(),!0)}widget(t,e){var o,n;if(!this.template||!t||!e)return;const{basic_configs:i,advanced_configs:l,plan:s}=e,r=null==(n=null==(o=this.template)?void 0:o.content)?void 0:n.cloneNode(!0),a=r.querySelector("[data-ngr-markets-modal]");return this.modal=a,2===s&&l&&""!==(null==l?void 0:l.html_id)&&a.setAttribute("id",null==l?void 0:l.html_id),this.builder(r,i,t,s)}genCustomStyles(t){if(!t)return;const{basic_configs:e,advanced_configs:o,plan:n}=t,i=document.createElement("style");let l="";if(e&&!(null==o?void 0:o.disable_basic_css)&&3!==n){const{modalBgColor:t,modalTextColor:o,modalBorderColor:n,buttonsBgColor:i,buttonsColor:s,font:r}=e;l+=`\n        .ngr-markets-modal{\n          ${r&&""!=r&&"inherit"!==r&&"undefined"!==r?"font-family:'"+r+"', sans-serif;":""}\n        }\n        .ngr-markets-modal__content{\n          ${""!=t?"background-color:"+t+";":""}\n          ${""!=o?"color:"+o+";":""}\n          ${""!=n?"border-color:"+n+";":""}\n        }\n        ${""!=t&&".ngr-markets-modal__close{ background-color:"+t+" !important;}"}\n        .ngr-markets-modal__form-content .select select{\n          ${r&&""!=r&&"inherit"!==r&&"undefined"!==r?"font-family:'"+r+"', sans-serif;":""}\n        }\n        .ngr-markets-modal__button-main{\n            ${""!=i?"background-color:"+i+";":""}\n            ${""!=s?"border-color:"+s+";":""}\n            ${""!=s?"color:"+s+";":""}\n            ${""!=r?"font-family:'"+r+"', sans-serif;":""}\n        }\n        .ngr-markets-modal__button-main:hover{\n            ${""!=s?"background-color:"+s+";":""}\n            ${""!=i?"border-color:"+i+";":""}\n            ${""!=i?"color:"+i+";":""}\n        }\n        `}return o&&""!==o.css&&2===n&&(l+=o.css),i.textContent=l.replace(/\n/g,"").replace(/  +/g,""),i}customOpenerIcon(){var t;const e=document.querySelectorAll("[href$='#ngr-markets-open']");if(this.customOpenerIconSrc&&""!==this.customOpenerIconSrc&&(null==e?void 0:e.length)){const o=this.builOpenerIconElement(this.customOpenerIconSrc);if(!o)return;for(let n=0;n<e.length;n++){const i=e[n];(null==(t=null==i?void 0:i.textContent)?void 0:t.includes("[ngr-markets-icon]"))&&(i.innerHTML=i.innerHTML.replace(/\[ngr\-markets\-icon]/g,o))}}}widgetEvents(t,e,o){const n=this,i=t.querySelector("[data-ngr-markets-modal]");if(!i)return;const l=i.querySelector("[data-ngr-markets-close]");l&&l.addEventListener("click",()=>{n.closeModal(i,e)});const s=i.querySelector("[data-ngr-markets-toggle]");s&&s.addEventListener("click",()=>{n.toggleModal(i,e)});const r=i.querySelector("[data-ngr-markets-button]");r&&r.addEventListener("click",t=>{var o,l,s,r;if(n.analytics(),(null==(o=i.querySelector("[name='country_code']"))?void 0:o.value)===(null==(l=null==window?void 0:window.Shopify)?void 0:l.country)&&(null==(s=i.querySelector("[name='language_code']"))?void 0:s.value)===(null==(r=null==window?void 0:window.Shopify)?void 0:r.locale))return t.preventDefault(),void n.closeModal(i,e);n.closeModal(i,e,!0),i.classList.add("loading"),setTimeout(()=>{i.classList.remove("loading")},5e3)}),document.addEventListener("click",t=>{if(t){(t.target.closest("[data-ngr-markets-open]")||t.target.closest("[href$='#ngr-markets-open']"))&&(t.preventDefault(),n.openModal())}})}async widgetLogic(t,e,o){var n,i,l,s,r;if(!e||!t)return console.error("[NGR APP]: Configs or shadowRoot list not found. Contact app support please.");const{showRules:a,showFrequency:d}=e;if(this.testMode)this.openModal();else if("manual"!==a){if("autoGeo"===a){const t=o.MarketRegionCountry.map(t=>t.code),e=this.getCookie(this.VARS.KEY);if(e&&!this.testMode){const n=JSON.parse(e);if(!t.includes(n.country))return;return void this.widgetBehaviour(d,n,o)}const a=await this.getCountriesJSON(),c=await fetch("/browsing_context_suggestions.json").then(t=>t.json());if(!a||!c)return console.error("[NGR APP]: User GEO location or countries list not detected. Contact app support please.");const u=null==(n=null==c?void 0:c.detected_values)?void 0:n.country.handle,h={country_name:(null==(l=null==(i=null==c?void 0:c.detected_values)?void 0:i.country)?void 0:l.name)||(null==(s=null==c?void 0:c.detected_values)?void 0:s.country_name),country:u,continent:null==(r=a[u])?void 0:r.continent};if(this.setCookie(this.VARS.KEY,JSON.stringify(h),7),window[this.VARS.KEY]=h,!t.includes(h.country))return;return void this.widgetBehaviour(d,h,o)}this.widgetBehaviour(d)}}widgetBehaviour(t=this.SHOW_RULES.session,e,o){var n,i,l,s,r,a,d,c,u,h,g;if(!(null==e?void 0:e.country)&&t===this.SHOW_RULES.load)return this.openModal();const m=t=>{if("CH"===e.country||!window.location.host.includes("got-bag.com"))if(t===this.SHOW_RULES.load)this.openModal();else{(t===this.SHOW_RULES.cookie?this.getCookie(this.VARS.CLOSED_KEY):sessionStorage.getItem(this.VARS.CLOSED_KEY))||this.openModal()}},p=null==e?void 0:e.country;if(p){const e=null==(n=null==window?void 0:window.Shopify)?void 0:n.country,v=null==(i=null==window?void 0:window.Shopify)?void 0:i.locale,w=p&&(null==(l=null==window?void 0:window.ngr_countries_window[p])?void 0:l.languages[0]),f=null==(r=null==(s=null==o?void 0:o.MarketRegionCountry)?void 0:s.find(t=>(null==t?void 0:t.code)===p))?void 0:r.__parentId,y=null==(d=null==(a=null==o?void 0:o.Market)?void 0:a.find(t=>(null==t?void 0:t.id)===f))?void 0:d.webPresence;let S=[];if(y){S=[(null==(c=null==y?void 0:y.defaultLocale)?void 0:c.locale)?null==(u=null==y?void 0:y.defaultLocale)?void 0:u.locale:null==y?void 0:y.defaultLocale,...((null==(h=null==y?void 0:y.alternateLocales)?void 0:h.find(t=>t.locale))?null==(g=null==y?void 0:y.alternateLocales)?void 0:g.filter(t=>null==t?void 0:t.published).map(t=>t.locale):null==y?void 0:y.alternateLocales)||[]]}const _=e&&p&&e!==p,k=v&&w&&w!==v&&(null==S?void 0:S.includes(w));(_||k)&&m(t)}else m(t)}builder(t,e,o,n){var i,l,s;const{title:r,title_locales:a,text:d,text_locales:c,buttonText:u,buttonText_locales:h,showFlag:g,showFrequency:m,topbarSticky:p,stickyOpener:v,stickyVerticalPosition:w,icon:f,iconWidth:y,stickyToggleIcon:S,type:_}=e,k=this.getUserData(),b=(null==k?void 0:k.country_name)||(null==(i=window.ngr_countries_window[null==k?void 0:k.country])?void 0:i.name),C=null==(l=window.ngr_countries_window[null==k?void 0:k.country])?void 0:l.name;let E=r,L=d,O=u;2===n&&(E=this.getTranslation(r,a),L=this.getTranslation(d,c),O=this.getTranslation(u,h)),b&&(L=L.replace(/\[\[country\]\]/g,b)),C&&(L=L.replace(/\[\[country_eng\]\]/g,C));const M=t.querySelector("[data-ngr-markets-close]"),A=this.buildStickyIconElement(S,v,null==k?void 0:k.country,null==(s=null==window?void 0:window.Shopify)?void 0:s.country),R=this.buildIconElement(f,y),I=this.buildTitleElement(E),T=this.buildTextElement(L,n),$=this.buildMarketsDropdowns(o,e),D=this.buildFlagElement(null==k?void 0:k.country),x=t.querySelector("[data-ngr-markets-button]"),P=t.querySelector("[data-ngr-markets-content]");return"topbar"===_&&(this.modal.classList.add("top-bar"),p&&(this.style.top=0,this.style.position="sticky",this.style.zIndex="999999999999"),$.appendChild(x)),"sticky"===_&&(this.modal.classList.add("sticky-bar"),this.modal.style.top=w+"%",setTimeout(()=>{this.modal.classList.add("transition")},2500)),A&&"sticky"===_&&M&&(M.removeAttribute("data-ngr-markets-close"),M.setAttribute("data-ngr-markets-toggle",""),M.innerHTML="",M.appendChild(A)),R&&P.appendChild(R),I&&P.appendChild(I),T&&P.appendChild(T),D&&g&&P.appendChild(D),$&&P.appendChild($),x&&O&&(x.textContent=O),t}buildStickyIconElement(t,e,o,n){t="geo"===e&&o?this.flagSrc.replace("ac.svg",`${o.toLowerCase()}.svg`):"market"===e&&n?this.flagSrc.replace("ac.svg",`${n.toLowerCase()}.svg`):"default"===t?this.widgetStickyIcon:t;const i=document.createElement("img");return i.loading="lazy",i.alt="Geo location toggler",i.width=100,i.height=100,i.src=t,i}buildIconElement(t,e=100,o="Redirects Icon"){if(!t||""===t)return;const n=document.createElement("img");n.loading="lazy",n.alt=o,n.width=e,n.height=100,n.src="default"===t?this.widgetIcon:t;const i=document.createElement("div");return i.classList.add("ngr-markets-modal__icon"),i.appendChild(n),i}buildTitleElement(t){if(!t||""===t)return;const e=document.createElement("h2");return e.classList.add("ngr-markets-modal__title"),e.textContent=t,e}buildTextElement(t,e){if(!t||""===t||3===e||"<p><br></p>"===t||"<p><br/></p>"===t)return;const o=document.createElement("div");return o.classList.add("ngr-markets-modal__text"),o.innerHTML=t,o}buildMarketsDropdowns(t,e){var o,n,i,l;if(!t||!t.MarketRegionCountry.length)return;const{dropdownDefault:s,showLngSelector:r,showCountrySelector:a}=e;let d=null;const c=null==(o=t.Market)?void 0:o.filter(t=>t.enabled);c.sort((t,e)=>t.name>e.name?1:-1);const u=null==c?void 0:c.map(t=>t.id),h=document.createElement("div");if(h.classList.add("ngr-markets-modal__form-content"),a){const e=document.createElement("div");e.classList.add("select"),e.classList.add("country-selector");const o=document.createElement("select");o.name="country_code";const i=t.MarketRegionCountry;if(null==i||i.sort((t,e)=>t.name>e.name?1:-1),null==i||i.forEach(t=>{var e,n,i;if(!u.includes(t.__parentId))return;const l=document.createElement("option"),s=null==(e=null==window?void 0:window.ngr_currencies_window[t.currency.currencyCode])?void 0:e.symbol_native,r=(null==(n=null==window?void 0:window.ngr_countries_window[t.code])?void 0:n.native)||"";l.textContent=r!==t.name?t.name+" / "+r+` (${t.currency.currencyCode} ${s})`:t.name+` (${t.currency.currencyCode} ${s})`,l.value=t.code,l.setAttribute("data-market",t.__parentId),o.appendChild(l),t.code===(null==(i=null==this?void 0:this.userGeoData)?void 0:i.country)&&(d=t.code)}),this.userGeoData&&"market"!==s&&d)o.value=d;else{const t=o.options,e=null==(n=null==window?void 0:window.Shopify)?void 0:n.country,i=Array.from(t).some(t=>t.value===e);o.value=i?e:t.length>0?t[0].value:0}e.appendChild(o),h.appendChild(e)}const g=[];if(null==c||c.forEach(t=>{var e;null==(e=t.webPresence)||e.rootUrls.forEach(e=>g.push({...e,id:t.id}))}),r){let t=[];const e=h.querySelector(".country-selector select"),o=null==(i=null==c?void 0:c.find(t=>t.primary))?void 0:i.id,n=document.createElement("div");n.classList.add("select");const r=document.createElement("select");r.name="language_code",null==g||g.forEach(e=>{var n,i;const l=this.createLngOption(e,g,h,o);l&&r.appendChild(l);const a=null==e?void 0:e.locale,d=null==(i=null==window?void 0:window.ngr_countries_window[null==(n=null==this?void 0:this.userGeoData)?void 0:n.country])?void 0:i.languages;a&&d.includes(a)&&"market"!==s&&t.push(a)});this.userGeoData&&"market"!==s?(null==t?void 0:t.length)?r.value=t[0]:r.selectedIndex=0:r.value=null==(l=null==window?void 0:window.Shopify)?void 0:l.locale,a&&e&&e.addEventListener("change",()=>{r.options.length=0,null==g||g.forEach(t=>{const e=this.createLngOption(t,g,h,o);e&&r.appendChild(e),r.selectedIndex=0})}),n.appendChild(r),h.appendChild(n)}return h}createLngOption(t,e,o,n){var i;const l=o.querySelector(".country-selector select"),s=null==(i=null==l?void 0:l.options[l.selectedIndex])?void 0:i.getAttribute("data-market"),r=e.find(t=>t.id===s);if((null==t?void 0:t.id)!==s&&r||(null==t?void 0:t.id)!==n&&!r)return;const a=document.createElement("option"),d=null==window?void 0:window.ngr_languages_window[t.locale],c=(null==d?void 0:d.name)!==(null==d?void 0:d.native)?(null==d?void 0:d.name)+" / "+(null==d?void 0:d.native):null==d?void 0:d.name;return a.textContent=c||t.locale,a.value=t.locale,a.setAttribute("data-market",t.id),a}buildFlagElement(t){if(!t||""===t||!this.flagSrc||""===this.flagSrc)return;const e=this.flagSrc.replace("ac.svg",`${t.toLowerCase()}.svg`),o=document.createElement("div");o.classList.add("ngr-markets-modal__flag");const n=document.createElement("img");return n.loading="lazy",n.alt=t,n.width=100,n.height=50,n.src=e,o.appendChild(n),o}builOpenerIconElement(t){if(t&&""!==t)return`<img src="${t}" loading="lazy" alt="geo location icon" width="14" height="14" style="margin-right: 2px; transform: translateY(2px); "/>`}analytics(){var t;try{const e=null==(t=null==window?void 0:window.Shopify)?void 0:t.shop,o=`${this.HOST}/api/shop/markets-button?shop=${e}`;return void fetch(o)}catch(e){console.log(e)}}getTranslation(t,e){return t&&(e&&e[this.userLocale]||t)||""}openModal(t){const e=t||this.modal;e&&e.setAttribute("data-open","")}closeModal(t,e,o){const n=t||this.modal;n&&(o||n.removeAttribute("data-open"),e&&e===this.SHOW_RULES.session?sessionStorage.setItem(this.VARS.CLOSED_KEY,1):e&&e===this.SHOW_RULES.cookie&&this.setCookie(this.VARS.CLOSED_KEY,1,7))}toggleModal(t,e){const o=t||this.modal;o&&(o.hasAttribute("data-open")?this.closeModal(t,e):this.openModal(t))}getUserData(){return JSON.parse(this.getCookie(this.VARS.KEY))||(null==window?void 0:window[this.VARS.KEY])}async getCountriesJSON(){const t=localStorage.getItem("ngr_countries");if(t)return JSON.parse(t);const e=`${this.HOST}/api/countries.json`;try{const t=await fetch(e).then(t=>t.json());return localStorage.setItem("ngr_countries",JSON.stringify({...t})),t}catch(o){return!1}}displayWidget(){this.style.display="initial"}setCookie(t,e,o){var n="";if(o){var i=new Date;i.setTime(i.getTime()+24*o*60*60*1e3),n="; expires="+i.toUTCString()}document.cookie=t+"="+(e||"")+n+"; path=/"}getCookie(t){for(var e=t+"=",o=document.cookie.split(";"),n=0;n<o.length;n++){for(var i=o[n];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(e))return i.substring(e.length,i.length)}return null}deleteCookie(t){document.cookie=t+"=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;"}}customElements.define("ngr-app-markets",t)}();
