var __defProp=Object.defineProperty,__defNormalProp=(e,t,o)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,__publicField=(e,t,o)=>__defNormalProp(e,"symbol"!=typeof t?t+"":t,o);!function(){"use strict";class e extends HTMLElement{constructor(){super(),__publicField(this,"HOST","https://xapps-geo-ca956fdeab0c.herokuapp.com"),__publicField(this,"MAIN_CSS","native-geo-markets.min.css"),__publicField(this,"SHOW_RULES",{load:"everyload",cookie:"cookie",session:"session"}),__publicField(this,"VARS",{KEY:"ngr-markets-session",CLOSED_KEY:"ngr-markets-closed"}),this.template=this.querySelector("#NGR-Markets-Template"),this.stylesheet=document.querySelector(`[href*='${this.MAIN_CSS}']`),this.widgetIcon=this.dataset.widgetIcon,this.widgetStickyIcon=this.dataset.widgetStickyIcon,this.modal=null,this.customOpenerIconSrc=this.dataset.customOpenerIconSrc,this.testMode=!1,this.userLocale=this.dataset.lng||window.Shopify.locale,this.shopifyTemplate=this.dataset.shopifyTemplate,this.shopifytemplateDir=this.dataset.shopifyTemplateDir,this.flagSrc=this.dataset.flagSrc,this.marketCountries=null,this.userGeoData}async connectedCallback(){var e,t;if(this.checkTestMode(),this.clearLocalData(),!this.stylesheet)return void console.error("[NGR APP]: Stylesheet not found. Contact app support.");const o=await this.getData();if(!o||!o&&!o.status||!o.data)return void console.error("[NGR APP]: Store data not found. Contact app support.");const n=await this.getGeo();if(!n||!(null==n?void 0:n.country))return void console.error("[NGR APP]: GEO Location not detected. Contact app support.");this.userGeoData=n;const{markets:i,configs:l}=o.data;if(i){if(null==l?void 0:l.widget){if(this.topBarMoveTop(null==(e=null==l?void 0:l.basicConfigs)?void 0:e.type))return;const o=this.widget(i,l);if(!o)return void console.error("[NGR APP]: Widget not found. Contact app support.");const n=this.genCustomStyles(l),s=this.attachShadow({mode:"closed"});s.appendChild(this.stylesheet),n&&s.appendChild(n),s.appendChild(o),this.customOpenerIcon(),console.log("customOpenerIcon"),this.widgetEvents(s,null==(t=null==l?void 0:l.basicConfigs)?void 0:t.showFrequency),console.log("widgetEvents"),await this.widgetLogic(s,null==l?void 0:l.basicConfigs,i),console.log("widgetLogic"),this.displayWidget()}}else console.warn("[NGR APP]: Shopify Markets not configured.")}checkTestMode(){(window.location.search.includes("ngr-markets-test")||"#ngr-markets-test"===window.location.hash||"true"===this.dataset.testMode&&window.Shopify.designMode)&&(this.testMode=!0)}clearLocalData(){"#ngr-clear-user-data"===window.location.hash&&(this.deleteCookie(this.VARS.KEY),this.deleteCookie(this.VARS.CLOSED_KEY),sessionStorage.removeItem(this.VARS.KEY),sessionStorage.removeItem(this.VARS.CLOSED_KEY))}async getData(){var e;const t=null==(e=null==window?void 0:window.Shopify)?void 0:e.shop,o=`${this.HOST}/api/shop-markets?shop=${t}`;try{return await fetch(o).then(e=>e.json())}catch(n){console.log("Error",n)}}async getGeo(){var e,t,o,n,i;const l=this.getCookie(this.VARS.KEY);if(l&&!this.testMode)return JSON.parse(l);const s=null==window?void 0:window.ngr_countries_window,r=await fetch("/browsing_context_suggestions.json").then(e=>e.json());if(!s||!r)return console.error("[NGR APP]: User GEO location or countries list not detected. Contact app support please.");const a=null==(e=null==r?void 0:r.detected_values)?void 0:e.country.handle,d={country_name:(null==(o=null==(t=null==r?void 0:r.detected_values)?void 0:t.country)?void 0:o.name)||(null==(n=null==r?void 0:r.detected_values)?void 0:n.country_name),country:a,continent:null==(i=s[a])?void 0:i.continent};return this.setCookie(this.VARS.KEY,JSON.stringify(d),7),window[this.VARS.KEY]=d,d}topBarMoveTop(e){return"topbar"===e&&!this.hasAttribute("data-moved")&&(this.setAttribute("data-moved",""),document.body.insertBefore(this,document.body.firstChild),this.displayWidget(),!0)}widget(e,t){var o,n;if(!this.template||!e||!t)return;const{basicConfigs:i,advancedConfigs:l,plan:s}=t,r=null==(n=null==(o=this.template)?void 0:o.content)?void 0:n.cloneNode(!0),a=r.querySelector("[data-ngr-markets-modal]");return this.modal=a,2===s&&l&&""!==(null==l?void 0:l.html_id)&&a.setAttribute("id",null==l?void 0:l.html_id),console.log("widget",t),this.builder(r,i,e,s)}genCustomStyles(e){if(!e)return;const{basicConfigs:t,advancedConfigs:o,plan:n}=e,i=document.createElement("style");let l="";if(t&&!(null==o?void 0:o.disable_basic_css)&&3!==n){const{modalBgColor:e,modalTextColor:o,modalBorderColor:n,buttonsBgColor:i,buttonsColor:s,font:r}=t;l+=`\n        .ngr-markets-modal{\n          ${r&&""!=r&&"inherit"!==r&&"undefined"!==r?"font-family:'"+r+"', sans-serif;":""}\n        }\n        .ngr-markets-modal__content{\n          ${""!=e?"background-color:"+e+";":""}\n          ${""!=o?"color:"+o+";":""}\n          ${""!=n?"border-color:"+n+";":""}\n        }\n        ${""!=e&&".ngr-markets-modal__close{ background-color:"+e+" !important;}"}\n        .ngr-markets-modal__form-content .select select{\n          ${r&&""!=r&&"inherit"!==r&&"undefined"!==r?"font-family:'"+r+"', sans-serif;":""}\n        }\n        .ngr-markets-modal__button-main{\n            ${""!=i?"background-color:"+i+";":""}\n            ${""!=s?"border-color:"+s+";":""}\n            ${""!=s?"color:"+s+";":""}\n            ${""!=r?"font-family:'"+r+"', sans-serif;":""}\n        }\n        .ngr-markets-modal__button-main:hover{\n            ${""!=s?"background-color:"+s+";":""}\n            ${""!=i?"border-color:"+i+";":""}\n            ${""!=i?"color:"+i+";":""}\n        }\n        `}return o&&""!==o.css&&2===n&&(l+=o.css),i.textContent=l.replace(/\n/g,"").replace(/  +/g,""),i}customOpenerIcon(){var e;const t=document.querySelectorAll("[href$='#ngr-markets-open']");if(this.customOpenerIconSrc&&""!==this.customOpenerIconSrc&&(null==t?void 0:t.length)){const o=this.builOpenerIconElement(this.customOpenerIconSrc);if(!o)return;for(let n=0;n<t.length;n++){const i=t[n];(null==(e=null==i?void 0:i.textContent)?void 0:e.includes("[ngr-markets-icon]"))&&(i.innerHTML=i.innerHTML.replace(/\[ngr\-markets\-icon]/g,o))}}}widgetEvents(e,t,o){const n=this,i=e.querySelector("[data-ngr-markets-modal]");if(!i)return;const l=i.querySelector("[data-ngr-markets-close]");l&&l.addEventListener("click",()=>{n.closeModal(i,t)});const s=i.querySelector("[data-ngr-markets-toggle]");s&&s.addEventListener("click",()=>{n.toggleModal(i,t)});const r=i.querySelector("[data-ngr-markets-button]");r&&r.addEventListener("click",e=>{var o,l,s,r;if(n.analytics(),(null==(o=i.querySelector("[name='country_code']"))?void 0:o.value)===(null==(l=null==window?void 0:window.Shopify)?void 0:l.country)&&(null==(s=i.querySelector("[name='language_code']"))?void 0:s.value)===(null==(r=null==window?void 0:window.Shopify)?void 0:r.locale))return e.preventDefault(),void n.closeModal(i,t);n.closeModal(i,t,!0),i.classList.add("loading"),setTimeout(()=>{i.classList.remove("loading")},5e3)}),document.addEventListener("click",e=>{if(e){(e.target.closest("[data-ngr-markets-open]")||e.target.closest("[href$='#ngr-markets-open']"))&&(e.preventDefault(),n.openModal())}})}async widgetLogic(e,t,o){var n,i,l,s,r;if(!t||!e)return console.error("[NGR APP]: Configs or shadowRoot list not found. Contact app support please.");const{showRules:a,showFrequency:d}=t;if(this.testMode)this.openModal();else if("manual"!==a){if("autoGeo"===a){const e=o.MarketRegionCountry.map(e=>e.code),t=this.getCookie(this.VARS.KEY);if(t&&!this.testMode){const n=JSON.parse(t);if(!e.includes(n.country))return;return void this.widgetBehaviour(d,n,o)}const a=await this.getCountriesJSON(),c=await fetch("/browsing_context_suggestions.json").then(e=>e.json());if(!a||!c)return console.error("[NGR APP]: User GEO location or countries list not detected. Contact app support please.");const u=null==(n=null==c?void 0:c.detected_values)?void 0:n.country.handle,h={country_name:(null==(l=null==(i=null==c?void 0:c.detected_values)?void 0:i.country)?void 0:l.name)||(null==(s=null==c?void 0:c.detected_values)?void 0:s.country_name),country:u,continent:null==(r=a[u])?void 0:r.continent};if(this.setCookie(this.VARS.KEY,JSON.stringify(h),7),window[this.VARS.KEY]=h,!e.includes(h.country))return;return void this.widgetBehaviour(d,h,o)}this.widgetBehaviour(d)}}widgetBehaviour(e=this.SHOW_RULES.session,t,o){var n,i,l,s,r,a,d,c,u,h,g;if(!(null==t?void 0:t.country)&&e===this.SHOW_RULES.load)return this.openModal();console.log("userLocation",t);const p=e=>{if("CH"===(null==t?void 0:t.country)||!window.location.host.includes("got-bag.com"))if(e===this.SHOW_RULES.load)this.openModal();else{(e===this.SHOW_RULES.cookie?this.getCookie(this.VARS.CLOSED_KEY):sessionStorage.getItem(this.VARS.CLOSED_KEY))||this.openModal()}},v=null==t?void 0:t.country;if(v){const t=null==(n=null==window?void 0:window.Shopify)?void 0:n.country,m=null==(i=null==window?void 0:window.Shopify)?void 0:i.locale,w=v&&(null==(l=null==window?void 0:window.ngr_countries_window[v])?void 0:l.languages[0]),f=null==(r=null==(s=null==o?void 0:o.MarketRegionCountry)?void 0:s.find(e=>(null==e?void 0:e.code)===v))?void 0:r.__parentId,y=null==(d=null==(a=null==o?void 0:o.Market)?void 0:a.find(e=>(null==e?void 0:e.id)===f))?void 0:d.webPresence;let S=[];if(y){S=[(null==(c=null==y?void 0:y.defaultLocale)?void 0:c.locale)?null==(u=null==y?void 0:y.defaultLocale)?void 0:u.locale:null==y?void 0:y.defaultLocale,...((null==(h=null==y?void 0:y.alternateLocales)?void 0:h.find(e=>e.locale))?null==(g=null==y?void 0:y.alternateLocales)?void 0:g.filter(e=>null==e?void 0:e.published).map(e=>e.locale):null==y?void 0:y.alternateLocales)||[]]}const _=t&&v&&t!==v,k=m&&w&&w!==m&&(null==S?void 0:S.includes(w));(_||k)&&p(e)}else p(e)}builder(e,t,o,n){var i,l,s;const{title:r,title_locales:a,text:d,text_locales:c,buttonText:u,buttonText_locales:h,showFlag:g,showFrequency:p,topbarSticky:v,stickyOpener:m,stickyVerticalPosition:w,icon:f,iconWidth:y,stickyToggleIcon:S,type:_}=t,k=this.getUserData(),b=(null==k?void 0:k.country_name)||(null==(i=window.ngr_countries_window[null==k?void 0:k.country])?void 0:i.name),C=null==(l=window.ngr_countries_window[null==k?void 0:k.country])?void 0:l.name;let E=r,L=d,I=u;2===n&&(E=this.getTranslation(r,a),L=this.getTranslation(d,c),I=this.getTranslation(u,h)),b&&(L=L.replace(/\[\[country\]\]/g,b)),C&&(L=L.replace(/\[\[country_eng\]\]/g,C));const O=e.querySelector("[data-ngr-markets-close]"),M=this.buildStickyIconElement(S,m,null==k?void 0:k.country,null==(s=null==window?void 0:window.Shopify)?void 0:s.country),A=this.buildIconElement(f,y),R=this.buildTitleElement(E),T=this.buildTextElement(L,n),P=this.buildMarketsDropdowns(o,t),$=this.buildFlagElement(null==k?void 0:k.country),x=e.querySelector("[data-ngr-markets-button]"),D=e.querySelector("[data-ngr-markets-content]");return"topbar"===_&&(this.modal.classList.add("top-bar"),v&&(this.style.top=0,this.style.position="sticky",this.style.zIndex="999999999999"),P&&P.appendChild(x)),"sticky"===_&&(this.modal.classList.add("sticky-bar"),this.modal.style.top=w+"%",setTimeout(()=>{this.modal.classList.add("transition")},2500)),M&&"sticky"===_&&O&&(O.removeAttribute("data-ngr-markets-close"),O.setAttribute("data-ngr-markets-toggle",""),O.innerHTML="",O.appendChild(M)),A&&D.appendChild(A),R&&D.appendChild(R),T&&D.appendChild(T),$&&g&&D.appendChild($),P&&D.appendChild(P),x&&I&&(x.textContent=I),e}buildStickyIconElement(e,t,o,n){e="geo"===t&&o?this.flagSrc.replace(/\b([a-z]+)\.svg/,`${o.toLowerCase()}.svg`):"market"===t&&n?this.flagSrc.replace(/\b([a-z]+)\.svg/,`${n.toLowerCase()}.svg`):"default"===e?this.widgetStickyIcon:e;const i=document.createElement("img");return i.loading="lazy",i.alt="Geo location toggler",i.width=100,i.height=100,i.src=e,i}buildIconElement(e,t=100,o="Redirects Icon"){if(!e||""===e)return;const n=document.createElement("img");n.loading="lazy",n.alt=o,n.width=t,n.height=100,n.src="default"===e?this.widgetIcon:e;const i=document.createElement("div");return i.classList.add("ngr-markets-modal__icon"),i.appendChild(n),i}buildTitleElement(e){if(!e||""===e)return;const t=document.createElement("h2");return t.classList.add("ngr-markets-modal__title"),t.textContent=e,t}buildTextElement(e,t){if(!e||""===e||3===t||"<p><br></p>"===e||"<p><br/></p>"===e)return;const o=document.createElement("div");return o.classList.add("ngr-markets-modal__text"),o.innerHTML=e,o}buildMarketsDropdowns(e,t){var o,n,i,l,s,r;if(!e||!e.MarketRegionCountry.length)return;const{dropdownDefault:a,showLngSelector:d,showCountrySelector:c}=t,{MarketRegionCountry:u,Market:h,MarketWebPresence:g,BackupRegion:p}=e;let v=null;const m=u.sort((e,t)=>e.name>t.name?1:-1),w=null==h?void 0:h.filter(e=>(null==e?void 0:e.enabled)||"ACTIVE"===(null==e?void 0:e.status)),f=null==w?void 0:w.map(e=>e.id),y=m.filter(e=>f.includes(e.__parentId)),S=(null==g?void 0:g.length)?null==(o=null==u?void 0:u.find(e=>e.id===(null==p?void 0:p.id)))?void 0:o.__parentId:null==(n=null==y?void 0:y.find(e=>e.primary))?void 0:n.__parentId,_=document.createElement("div");if(_.classList.add("ngr-markets-modal__form-content"),c){const e=document.createElement("div");e.classList.add("select"),e.classList.add("country-selector");const t=document.createElement("select");t.name="country_code";if(null==y||y.forEach(e=>{var o,n,i;const l=document.createElement("option"),s=null==(o=null==window?void 0:window.ngr_currencies_window[e.currency.currencyCode])?void 0:o.symbol_native,r=(null==(n=null==window?void 0:window.ngr_countries_window[e.code])?void 0:n.native)||"";l.textContent=r!==e.name?e.name+" / "+r+` (${e.currency.currencyCode} ${s})`:e.name+` (${e.currency.currencyCode} ${s})`,l.value=e.code,l.setAttribute("data-market",e.__parentId),t.appendChild(l),e.code===(null==(i=null==this?void 0:this.userGeoData)?void 0:i.country)&&(v=e.code)}),this.userGeoData&&"market"!==a&&v)t.value=v;else{const e=t.options,o=null==(i=null==window?void 0:window.Shopify)?void 0:i.country,n=Array.from(e).some(e=>e.value===o);t.value=n?o:e.length>0?e[0].value:0}e.appendChild(t),_.appendChild(e)}const k=[],b=_.querySelector(".country-selector select"),C=null==b?void 0:b.options[null==b?void 0:b.selectedIndex],E=(null==C?void 0:C.getAttribute("data-market"))||S;if(null==g?void 0:g.length){console.log("New Market",g);const e=g.find(e=>e.__parentId===E);null==(l=null==e?void 0:e.rootUrls)||l.forEach(e=>k.push({...e,marketId:E}))}else{const e=h.find(e=>!((null==e?void 0:e.id)!==E||!(null==e?void 0:e.webPresence))||(null==e?void 0:e.primary));console.log("Old Market",h,e,E),null==(s=null==e?void 0:e.webPresence)||s.rootUrls.forEach(t=>k.push({...t,marketId:e.id}))}if(console.log("allWebPresences",k),d){let e=[];const t=_.querySelector(".country-selector select"),o=document.createElement("div");o.classList.add("select");const n=document.createElement("select");n.name="language_code",null==k||k.forEach(t=>{var o,i;const l=this.createLngOption(t);l&&n.appendChild(l);const s=null==t?void 0:t.locale,r=null==(i=null==window?void 0:window.ngr_countries_window[null==(o=null==this?void 0:this.userGeoData)?void 0:o.country])?void 0:i.languages;s&&r.includes(s)&&"market"!==a&&e.push(s)});this.userGeoData&&"market"!==a?(null==e?void 0:e.length)?n.value=e[0]:n.selectedIndex=0:n.value=null==(r=null==window?void 0:window.Shopify)?void 0:r.locale,c&&t&&t.addEventListener("change",e=>{var t,o,i,l;const s=null==(o=null==e?void 0:e.target)?void 0:o.options[null==(t=null==e?void 0:e.target)?void 0:t.selectedIndex],r=(null==s?void 0:s.getAttribute("data-market"))||S;if(!r)return;n.options.length=0;const a=[];if(null==g?void 0:g.length){const e=g.find(e=>e.__parentId===r);null==(i=null==e?void 0:e.rootUrls)||i.forEach(e=>a.push({...e,marketId:r}))}else{const e=h.find(e=>e.id===r||e.primary);null==(l=null==e?void 0:e.webPresence)||l.rootUrls.forEach(t=>a.push({...t,marketId:e.id}))}(null==a?void 0:a.length)&&(null==a||a.forEach(e=>{const t=this.createLngOption(e);t&&n.appendChild(t),n.selectedIndex=0}))}),o.appendChild(n),_.appendChild(o)}return _}createLngOption(e){const t=document.createElement("option"),o=null==window?void 0:window.ngr_languages_window[e.locale],n=(null==o?void 0:o.name)!==(null==o?void 0:o.native)?(null==o?void 0:o.name)+" / "+(null==o?void 0:o.native):null==o?void 0:o.name;return t.textContent=n||e.locale,t.value=e.locale,t.setAttribute("data-market",e.marketId),t}buildFlagElement(e){if(!e||""===e||!this.flagSrc||""===this.flagSrc)return;const t=this.flagSrc.replace(/\b([a-z]+)\.svg/,`${e.toLowerCase()}.svg`),o=document.createElement("div");o.classList.add("ngr-markets-modal__flag");const n=document.createElement("img");return n.loading="lazy",n.alt=e,n.width=100,n.height=50,n.src=t,o.appendChild(n),o}builOpenerIconElement(e){if(e&&""!==e)return`<img src="${e}" loading="lazy" alt="geo location icon" width="14" height="14" style="margin-right: 2px; transform: translateY(2px); "/>`}analytics(){var e;try{const t=null==(e=null==window?void 0:window.Shopify)?void 0:e.shop,o=`${this.HOST}/api/analytics/markets-button?shop=${t}`;return void fetch(o)}catch(t){console.log(t)}}getTranslation(e,t){return e&&(t&&t[this.userLocale]||e)||""}openModal(e){const t=e||this.modal;t&&t.setAttribute("data-open","")}closeModal(e,t,o){const n=e||this.modal;n&&(o||n.removeAttribute("data-open"),t&&t===this.SHOW_RULES.session?sessionStorage.setItem(this.VARS.CLOSED_KEY,1):t&&t===this.SHOW_RULES.cookie&&this.setCookie(this.VARS.CLOSED_KEY,1,7))}toggleModal(e,t){const o=e||this.modal;o&&(o.hasAttribute("data-open")?this.closeModal(e,t):this.openModal(e))}getUserData(){return JSON.parse(this.getCookie(this.VARS.KEY))||(null==window?void 0:window[this.VARS.KEY])}async getCountriesJSON(){const e=localStorage.getItem("ngr_countries");if(e)return JSON.parse(e);const t=`${this.HOST}/api/countries`;try{const e=await fetch(t).then(e=>e.json());return localStorage.setItem("ngr_countries",JSON.stringify({...e})),e}catch(o){return!1}}displayWidget(){this.style.display="initial"}setCookie(e,t,o){var n="";if(o){var i=new Date;i.setTime(i.getTime()+24*o*60*60*1e3),n="; expires="+i.toUTCString()}document.cookie=e+"="+(t||"")+n+"; path=/"}getCookie(e){for(var t=e+"=",o=document.cookie.split(";"),n=0;n<o.length;n++){for(var i=o[n];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(t))return i.substring(t.length,i.length)}return null}deleteCookie(e){document.cookie=e+"=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;"}}customElements.define("ngr-app-markets",e)}();
